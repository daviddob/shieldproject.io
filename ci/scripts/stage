#!/bin/bash

set -eu

header() {
	echo "#########################################"
	echo
	echo $*
	echo
	echo "#########################################"
	echo
	echo
}

header "Downloading hugo" # FIXME: put in starkandwayne/concourse
mkdir hugo
pushd hugo
	curl -LO https://github.com/gohugoio/hugo/releases/download/v0.36/hugo_0.36_Linux-64bit.tar.gz
	tar -xzvf hugo_0.36_Linux-64bit.tar.gz
	chmod 755 hugo
popd
export PATH=$PATH:$PWD/hugo

header "Re-building Website Static Assets"
pushd git
	make
popd

pushd git
	cp nginx.conf public/
popd

header "Publishing staging.shieldproject.io"
pushd git
	cf api $CF_API_URL
	cf auth $CF_USERNAME "$CF_PASSWORD"
	cf target -o $CF_ORG -s $CF_SPACE
	cf push -f $MANIFEST
popd
