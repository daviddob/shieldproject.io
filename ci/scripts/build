#!/bin/bash
set -eu

header() {
	echo "#########################################"
	echo
	echo $*
	echo
	echo "#########################################"
	echo
	echo
}

VERSION=$(cat releases/version)
RELEASE="https://github.com/starkandwayne/shield/releases/tag/$(cat releases/tag)"

header "Getting Release Notes for SHIELD v$VERSION"
cat releases/body
(
cat git/data/releases.json | \
    jq -r '{"all":.all}' | spruce merge -
echo "- notes: |"
cat releases/body | sed -e 's/^/    /'
echo
echo "  url:     $RELEASE"
echo "  version: $VERSION"
) | spruce json | jq -r .
# FIXME: put releases json SOMEWHERE

header "Syncing docs/ from SHIELD codebase"
cp -a shield-code/docs git/content/docs
ls -lah git/content/docs

header "Publishing staging.shieldproject.io"
pushd git
cf api $CF_API_URL
cf auth $CF_USERNAME "$CF_PASSWORD"
cf target -o $CF_ORG -s $CF_SPACE
cf push -f manifest-stage.yml
popd


echo "DONE"
